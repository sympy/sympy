

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sympy.utilities.runtests &mdash; SymPy 0.7.3 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="http://live.sympy.org/static/live-core.css" type="text/css" />
    <link rel="stylesheet" href="http://live.sympy.org/static/live-autocomplete.css" type="text/css" />
    <link rel="stylesheet" href="http://live.sympy.org/static/live-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.7.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS_HTML-full"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/utilities.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/external/classy.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/live-core.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/live-autocomplete.js"></script>
    <script type="text/javascript" src="http://live.sympy.org/static/live-sphinx.js"></script>
    <script type="text/javascript" src="../../../_static/sidebar.js"></script>
    <link rel="shortcut icon" href="../../../_static/SymPy-Favicon.ico"/>
    <link rel="top" title="SymPy 0.7.3 documentation" href="../../../index.html" />
    <link rel="up" title="sympy" href="../../sympy.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SymPy 0.7.3 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../sympy.html" accesskey="U">sympy</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for sympy.utilities.runtests</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is our testing framework.</span>

<span class="sd">Goals:</span>

<span class="sd">* it should be compatible with py.test and operate very similarly</span>
<span class="sd">  (or identically)</span>
<span class="sd">* doesn&#39;t require any external dependencies</span>
<span class="sd">* preferably all the functionality should be in this file only</span>
<span class="sd">* no magic, just import the test file and execute the test functions, that&#39;s it</span>
<span class="sd">* portable</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">division</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">linecache</span>
<span class="kn">from</span> <span class="nn">fnmatch</span> <span class="kn">import</span> <span class="n">fnmatch</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="kn">import</span> <span class="n">default_timer</span> <span class="k">as</span> <span class="n">clock</span>
<span class="kn">import</span> <span class="nn">doctest</span> <span class="kn">as</span> <span class="nn">pdoctest</span>  <span class="c"># avoid clashing with our doctest() function</span>
<span class="kn">from</span> <span class="nn">doctest</span> <span class="kn">import</span> <span class="n">DocTestFinder</span><span class="p">,</span> <span class="n">DocTestRunner</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">stat</span>

<span class="kn">from</span> <span class="nn">sympy.core.cache</span> <span class="kn">import</span> <span class="n">clear_cache</span>
<span class="kn">from</span> <span class="nn">sympy.core.compatibility</span> <span class="kn">import</span> <span class="n">exec_</span><span class="p">,</span> <span class="n">PY3</span><span class="p">,</span> <span class="n">get_function_code</span><span class="p">,</span> <span class="n">string_types</span>
<span class="kn">from</span> <span class="nn">sympy.utilities.misc</span> <span class="kn">import</span> <span class="n">find_executable</span>
<span class="kn">from</span> <span class="nn">sympy.external</span> <span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">sympy.utilities.exceptions</span> <span class="kn">import</span> <span class="n">SymPyDeprecationWarning</span>

<span class="c"># Use sys.stdout encoding for ouput.</span>
<span class="n">pdoctest</span><span class="o">.</span><span class="n">_encoding</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="o">.</span><span class="n">encoding</span>

<span class="n">IS_PYTHON_3</span> <span class="o">=</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">IS_WINDOWS</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;nt&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Skipped</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="kn">import</span> <span class="nn">__future__</span>
<span class="c"># add more flags ??</span>
<span class="n">future_flags</span> <span class="o">=</span> <span class="n">__future__</span><span class="o">.</span><span class="n">division</span><span class="o">.</span><span class="n">compiler_flag</span>

<span class="k">def</span> <span class="nf">_indent</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Add the given number of space characters to the beginning of</span>
<span class="sd">    every non-blank line in ``s``, and return the result.</span>
<span class="sd">    If the string ``s`` is Unicode, it is encoded using the stdout</span>
<span class="sd">    encoding and the ``backslashreplace`` error handler.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># After a 2to3 run the below code is bogus, so wrap it with a version check</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">pdoctest</span><span class="o">.</span><span class="n">_encoding</span><span class="p">,</span> <span class="s">&#39;backslashreplace&#39;</span><span class="p">)</span>
    <span class="c"># This regexp matches the start of non-blank lines:</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;(?m)^(?!$)&#39;</span><span class="p">,</span> <span class="n">indent</span><span class="o">*</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

<span class="n">pdoctest</span><span class="o">.</span><span class="n">_indent</span> <span class="o">=</span> <span class="n">_indent</span>

<span class="c"># ovverride reporter to maintain windows and python3</span>


<span class="k">def</span> <span class="nf">_report_failure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">example</span><span class="p">,</span> <span class="n">got</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Report that the given example failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checker</span><span class="o">.</span><span class="n">output_difference</span><span class="p">(</span><span class="n">example</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optionflags</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;raw_unicode_escape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">out</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failure_header</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">example</span><span class="p">)</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span>

<span class="k">if</span> <span class="n">IS_PYTHON_3</span> <span class="ow">and</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
    <span class="n">DocTestRunner</span><span class="o">.</span><span class="n">report_failure</span> <span class="o">=</span> <span class="n">_report_failure</span>


<div class="viewcode-block" id="convert_to_native_paths"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.convert_to_native_paths">[docs]</a><span class="k">def</span> <span class="nf">convert_to_native_paths</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts a list of &#39;/&#39; separated paths into a list of</span>
<span class="sd">    native (os.sep separated) paths and converts to lowercase</span>
<span class="sd">    if the system is case insensitive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">newlst</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">rv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">))</span>
        <span class="c"># on windows the slash after the colon is dropped</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rv</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="n">rv</span><span class="p">[:</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">rv</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">newlst</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sys_normcase</span><span class="p">(</span><span class="n">rv</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">newlst</span>

</div>
<div class="viewcode-block" id="get_sympy_dir"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.get_sympy_dir">[docs]</a><span class="k">def</span> <span class="nf">get_sympy_dir</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the root sympy directory and set the global value</span>
<span class="sd">    indicating whether the system is case sensitive or not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">sys_case_insensitive</span>

    <span class="n">this_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
    <span class="n">sympy_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">this_file</span><span class="p">),</span> <span class="s">&quot;..&quot;</span><span class="p">,</span> <span class="s">&quot;..&quot;</span><span class="p">)</span>
    <span class="n">sympy_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">sympy_dir</span><span class="p">)</span>
    <span class="n">sys_case_insensitive</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">sympy_dir</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">sympy_dir</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span> <span class="ow">and</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">sympy_dir</span><span class="o">.</span><span class="n">upper</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">sys_normcase</span><span class="p">(</span><span class="n">sympy_dir</span><span class="p">)</span>

</div>
<span class="k">def</span> <span class="nf">sys_normcase</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">sys_case_insensitive</span><span class="p">:</span>  <span class="c"># global defined after call to get_sympy_dir()</span>
        <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">f</span>


<div class="viewcode-block" id="isgeneratorfunction"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.isgeneratorfunction">[docs]</a><span class="k">def</span> <span class="nf">isgeneratorfunction</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return True if the object is a user-defined generator function.</span>

<span class="sd">    Generator function objects provides same attributes as functions.</span>

<span class="sd">    See isfunction.__doc__ for attributes listing.</span>

<span class="sd">    Adapted from Python 2.6.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">CO_GENERATOR</span> <span class="o">=</span> <span class="mh">0x20</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="nb">object</span><span class="p">))</span> <span class="ow">and</span> \
            <span class="n">get_function_code</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span><span class="o">.</span><span class="n">co_flags</span> <span class="o">&amp;</span> <span class="n">CO_GENERATOR</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="bp">False</span>

</div>
<span class="k">def</span> <span class="nf">setup_pprint</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">pprint_use_unicode</span><span class="p">,</span> <span class="n">init_printing</span>

    <span class="c"># force pprint to be in ascii mode in doctests</span>
    <span class="n">pprint_use_unicode</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># hook our nice, hash-stable strprinter</span>
    <span class="n">init_printing</span><span class="p">(</span><span class="n">pretty_print</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>


<div class="viewcode-block" id="run_in_subprocess_with_hash_randomization"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.run_in_subprocess_with_hash_randomization">[docs]</a><span class="k">def</span> <span class="nf">run_in_subprocess_with_hash_randomization</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">function_args</span><span class="o">=</span><span class="p">(),</span>
    <span class="n">function_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">command</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span>
        <span class="n">module</span><span class="o">=</span><span class="s">&#39;sympy.utilities.runtests&#39;</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a function in a Python subprocess with hash randomization enabled.</span>

<span class="sd">    If hash randomization is not supported by the version of Python given, it</span>
<span class="sd">    returns False.  Otherwise, it returns the exit value of the command.  The</span>
<span class="sd">    function is passed to sys.exit(), so the return value of the function will</span>
<span class="sd">    be the return value.</span>

<span class="sd">    The environment variable PYTHONHASHSEED is used to seed Python&#39;s hash</span>
<span class="sd">    randomization.  If it is set, this function will return False, because</span>
<span class="sd">    starting a new subprocess is unnecessary in that case.  If it is not set,</span>
<span class="sd">    one is set at random, and the tests are run.  Note that if this</span>
<span class="sd">    environment variable is set when Python starts, hash randomization is</span>
<span class="sd">    automatically enabled.  To force a subprocess to be created even if</span>
<span class="sd">    PYTHONHASHSEED is set, pass ``force=True``.  This flag will not force a</span>
<span class="sd">    subprocess in Python versions that do not support hash randomization (see</span>
<span class="sd">    below), because those versions of Python do not support the ``-R`` flag.</span>

<span class="sd">    ``function`` should be a string name of a function that is importable from</span>
<span class="sd">    the module ``module``, like &quot;_test&quot;.  The default for ``module`` is</span>
<span class="sd">    &quot;sympy.utilities.runtests&quot;.  ``function_args`` and ``function_kwargs``</span>
<span class="sd">    should be a repr-able tuple and dict, respectively.  The default Python</span>
<span class="sd">    command is sys.executable, which is the currently running Python command.</span>

<span class="sd">    This function is necessary because the seed for hash randomization must be</span>
<span class="sd">    set by the environment variable before Python starts.  Hence, in order to</span>
<span class="sd">    use a predetermined seed for tests, we must start Python in a separate</span>
<span class="sd">    subprocess.</span>

<span class="sd">    Hash randomization was added in the minor Python versions 2.6.8, 2.7.3,</span>
<span class="sd">    3.1.5, and 3.2.3, and is enabled by default in all Python versions after</span>
<span class="sd">    and including 3.3.0.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; from sympy.utilities.runtests import (</span>
<span class="sd">    ... run_in_subprocess_with_hash_randomization)</span>
<span class="sd">    &gt;&gt;&gt; # run the core tests in verbose mode</span>
<span class="sd">    &gt;&gt;&gt; run_in_subprocess_with_hash_randomization(&quot;_test&quot;,</span>
<span class="sd">    ... function_args=(&quot;core&quot;,),</span>
<span class="sd">    ... function_kwargs={&#39;verbose&#39;: True}) # doctest: +SKIP</span>
<span class="sd">    # Will return 0 if sys.executable supports hash randomization and tests</span>
<span class="sd">    # pass, 1 if they fail, and False if it does not support hash</span>
<span class="sd">    # randomization.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c"># Note, we must return False everywhere, not None, as subprocess.call will</span>
    <span class="c"># sometimes return None.</span>

    <span class="c"># First check if the Python version supports hash randomization</span>
    <span class="c"># If it doesn&#39;t have this support, it won&#39;t reconize the -R flag</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;-RV&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                         <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="n">hash_seed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;PYTHONHASHSEED&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">hash_seed</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;PYTHONHASHSEED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">32</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="c"># Now run the command</span>
    <span class="n">commandstring</span> <span class="o">=</span> <span class="p">(</span><span class="s">&quot;import sys; from </span><span class="si">%s</span><span class="s"> import </span><span class="si">%s</span><span class="s">;sys.exit(</span><span class="si">%s</span><span class="s">(*</span><span class="si">%s</span><span class="s">, **</span><span class="si">%s</span><span class="s">))&quot;</span> <span class="o">%</span>
                     <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">function_args</span><span class="p">),</span>
                     <span class="nb">repr</span><span class="p">(</span><span class="n">function_kwargs</span><span class="p">)))</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="n">command</span><span class="p">,</span> <span class="s">&quot;-R&quot;</span><span class="p">,</span> <span class="s">&quot;-c&quot;</span><span class="p">,</span> <span class="n">commandstring</span><span class="p">])</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c"># Put the environment variable back, so that it reads correctly for</span>
        <span class="c"># the current Python process.</span>
        <span class="k">if</span> <span class="n">hash_seed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;PYTHONHASHSEED&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;PYTHONHASHSEED&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hash_seed</span>

</div>
<div class="viewcode-block" id="run_all_tests"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.run_all_tests">[docs]</a><span class="k">def</span> <span class="nf">run_all_tests</span><span class="p">(</span><span class="n">test_args</span><span class="o">=</span><span class="p">(),</span> <span class="n">test_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">doctest_args</span><span class="o">=</span><span class="p">(),</span>
                  <span class="n">doctest_kwargs</span><span class="o">=</span><span class="p">{},</span> <span class="n">examples_args</span><span class="o">=</span><span class="p">(),</span> <span class="n">examples_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;quiet&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run all tests.</span>

<span class="sd">    Right now, this runs the regular tests (bin/test), the doctests</span>
<span class="sd">    (bin/doctest), the examples (examples/all.py), and the sage tests (see</span>
<span class="sd">    sympy/external/tests/test_sage.py).</span>

<span class="sd">    This is what ``setup.py test`` uses.</span>

<span class="sd">    You can pass arguments and keyword arguments to the test functions that</span>
<span class="sd">    support them (for now, test,  doctest, and the examples). See the</span>
<span class="sd">    docstrings of those functions for a description of the available options.</span>

<span class="sd">    For example, to run the solvers tests with colors turned off:</span>

<span class="sd">    &gt;&gt;&gt; from sympy.utilities.runtests import run_all_tests</span>
<span class="sd">    &gt;&gt;&gt; run_all_tests(test_args=(&quot;solvers&quot;,),</span>
<span class="sd">    ... test_kwargs={&quot;colors:False&quot;}) # doctest: +SKIP</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tests_successful</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c"># Regular tests</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span><span class="p">(</span><span class="o">*</span><span class="n">test_args</span><span class="p">,</span> <span class="o">**</span><span class="n">test_kwargs</span><span class="p">):</span>
            <span class="c"># some regular test fails, so set the tests_successful</span>
            <span class="c"># flag to false and continue running the doctests</span>
            <span class="n">tests_successful</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Doctests</span>
        <span class="k">print</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">doctest</span><span class="p">(</span><span class="o">*</span><span class="n">doctest_args</span><span class="p">,</span> <span class="o">**</span><span class="n">doctest_kwargs</span><span class="p">):</span>
            <span class="n">tests_successful</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Examples</span>
        <span class="k">print</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;examples&quot;</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">all</span> <span class="kn">import</span> <span class="n">run_examples</span>  <span class="c"># examples/all.py</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">run_examples</span><span class="p">(</span><span class="o">*</span><span class="n">examples_args</span><span class="p">,</span> <span class="o">**</span><span class="n">examples_kwargs</span><span class="p">):</span>
            <span class="n">tests_successful</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="c"># Sage tests</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span> <span class="ow">or</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">):</span>
            <span class="c"># run Sage tests; Sage currently doesn&#39;t support Windows or Python 3</span>
            <span class="n">dev_null</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;sage -v&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">dev_null</span><span class="p">,</span>
                               <span class="n">stderr</span><span class="o">=</span><span class="n">dev_null</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s">&quot;sage -python bin/test &quot;</span>
                                   <span class="s">&quot;sympy/external/tests/test_sage.py&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tests_successful</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="n">tests_successful</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Return nonzero exit code</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">print</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;DO *NOT* COMMIT!&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="test"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.test">[docs]</a><span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run tests in the specified test_*.py files.</span>

<span class="sd">    Tests in a particular test_*.py file are run if any of the given strings</span>
<span class="sd">    in ``paths`` matches a part of the test file&#39;s path. If ``paths=[]``,</span>
<span class="sd">    tests in all test_*.py files are run.</span>

<span class="sd">    Notes:</span>

<span class="sd">    - If sort=False, tests are run in random order (not default).</span>
<span class="sd">    - Paths can be entered in native system format or in unix,</span>
<span class="sd">      forward-slash format.</span>

<span class="sd">    **Explanation of test results**</span>

<span class="sd">    ======  ===============================================================</span>
<span class="sd">    Output  Meaning</span>
<span class="sd">    ======  ===============================================================</span>
<span class="sd">    .       passed</span>
<span class="sd">    F       failed</span>
<span class="sd">    X       XPassed (expected to fail but passed)</span>
<span class="sd">    f       XFAILed (expected to fail and indeed failed)</span>
<span class="sd">    s       skipped</span>
<span class="sd">    w       slow</span>
<span class="sd">    T       timeout (e.g., when ``--timeout`` is used)</span>
<span class="sd">    K       KeyboardInterrupt (when running the slow tests with ``--slow``,</span>
<span class="sd">            you can interrupt one of them without killing the test runner)</span>
<span class="sd">    ======  ===============================================================</span>


<span class="sd">    Colors have no additional meaning and are used just to facilitate</span>
<span class="sd">    interpreting the output.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; import sympy</span>

<span class="sd">    Run all tests:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test()    # doctest: +SKIP</span>

<span class="sd">    Run one file:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(&quot;sympy/core/tests/test_basic.py&quot;)    # doctest: +SKIP</span>
<span class="sd">    &gt;&gt;&gt; sympy.test(&quot;_basic&quot;)    # doctest: +SKIP</span>

<span class="sd">    Run all tests in sympy/functions/ and some particular file:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(&quot;sympy/core/tests/test_basic.py&quot;,</span>
<span class="sd">    ...        &quot;sympy/functions&quot;)    # doctest: +SKIP</span>

<span class="sd">    Run all tests in sympy/core and sympy/utilities:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(&quot;/core&quot;, &quot;/util&quot;)    # doctest: +SKIP</span>

<span class="sd">    Run specific test from a file:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(&quot;sympy/core/tests/test_basic.py&quot;,</span>
<span class="sd">    ...        kw=&quot;test_equality&quot;)    # doctest: +SKIP</span>

<span class="sd">    Run specific test from any file:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(kw=&quot;subs&quot;)    # doctest: +SKIP</span>

<span class="sd">    Run the tests with verbose mode on:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(verbose=True)    # doctest: +SKIP</span>

<span class="sd">    Don&#39;t sort the test output:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(sort=False)    # doctest: +SKIP</span>

<span class="sd">    Turn on post-mortem pdb:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(pdb=True)    # doctest: +SKIP</span>

<span class="sd">    Turn off colors:</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(colors=False)    # doctest: +SKIP</span>

<span class="sd">    Force colors, even when the output is not to a terminal (this is useful,</span>
<span class="sd">    e.g., if you are piping to ``less -r`` and you still want colors)</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(force_colors=False)    # doctest: +SKIP</span>

<span class="sd">    The traceback verboseness can be set to &quot;short&quot; or &quot;no&quot; (default is</span>
<span class="sd">    &quot;short&quot;)</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(tb=&#39;no&#39;)    # doctest: +SKIP</span>

<span class="sd">    You can disable running the tests in a separate subprocess using</span>
<span class="sd">    ``subprocess=False``.  This is done to support seeding hash randomization,</span>
<span class="sd">    which is enabled by default in the Python versions where it is supported.</span>
<span class="sd">    If subprocess=False, hash randomization is enabled/disabled according to</span>
<span class="sd">    whether it has been enabled or not in the calling Python process.</span>
<span class="sd">    However, even if it is enabled, the seed cannot be printed unless it is</span>
<span class="sd">    called from a new Python process.</span>

<span class="sd">    Hash randomization was added in the minor Python versions 2.6.8, 2.7.3,</span>
<span class="sd">    3.1.5, and 3.2.3, and is enabled by default in all Python versions after</span>
<span class="sd">    and including 3.3.0.</span>

<span class="sd">    If hash randomization is not supported ``subprocess=False`` is used</span>
<span class="sd">    automatically.</span>

<span class="sd">    &gt;&gt;&gt; sympy.test(subprocess=False)     # doctest: +SKIP</span>

<span class="sd">    To set the hash randomization seed, set the environment variable</span>
<span class="sd">    ``PYTHONHASHSEED`` before running the tests.  This can be done from within</span>
<span class="sd">    Python using</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; os.environ[&#39;PYTHONHASHSEED&#39;] = &#39;42&#39; # doctest: +SKIP</span>

<span class="sd">    Or from the command line using</span>

<span class="sd">    $ PYTHONHASHSEED=42 ./bin/test</span>

<span class="sd">    If the seed is not set, a random seed will be chosen.</span>

<span class="sd">    Note that to reproduce the same hash values, you must use both the same as</span>
<span class="sd">    well as the same architecture (32-bit vs. 64-bit).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subprocess</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;subprocess&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subprocess</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">run_in_subprocess_with_hash_randomization</span><span class="p">(</span><span class="s">&quot;_test&quot;</span><span class="p">,</span>
            <span class="n">function_args</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span> <span class="n">function_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_test</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="k">def</span> <span class="nf">_test</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal function that actually runs the tests.</span>

<span class="sd">    All keyword arguments from ``test()`` are passed to this function except for</span>
<span class="sd">    ``subprocess``.</span>

<span class="sd">    Returns 0 if tests passed and 1 if they failed.  See the docstring of</span>
<span class="sd">    ``test()`` for more information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">tb</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;tb&quot;</span><span class="p">,</span> <span class="s">&quot;short&quot;</span><span class="p">)</span>
    <span class="n">kw</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;kw&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="n">post_mortem</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;pdb&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;colors&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">force_colors</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;force_colors&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">sort</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;sort&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">seed</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;seed&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100000000</span><span class="p">)</span>
    <span class="n">timeout</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;timeout&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">slow</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;slow&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">enhance_asserts</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;enhance_asserts&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">PyTestReporter</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="n">tb</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span>
        <span class="n">force_colors</span><span class="o">=</span><span class="n">force_colors</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">SymPyTests</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">post_mortem</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>

    <span class="c"># Disable warnings for external modules</span>
    <span class="kn">import</span> <span class="nn">sympy.external</span>
    <span class="n">sympy</span><span class="o">.</span><span class="n">external</span><span class="o">.</span><span class="n">importtools</span><span class="o">.</span><span class="n">WARN_OLD_VERSION</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">sympy</span><span class="o">.</span><span class="n">external</span><span class="o">.</span><span class="n">importtools</span><span class="o">.</span><span class="n">WARN_NOT_INSTALLED</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># Show deprecation warnings</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">SymPyDeprecationWarning</span><span class="p">)</span>

    <span class="n">test_files</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_test_files</span><span class="p">(</span><span class="s">&#39;sympy&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">_testfiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">test_files</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">convert_to_native_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">test_files</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
                    <span class="n">matched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="n">t</span><span class="o">.</span><span class="n">_testfiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
        <span class="n">slow</span><span class="o">=</span><span class="n">slow</span><span class="p">,</span> <span class="n">enhance_asserts</span><span class="o">=</span><span class="n">enhance_asserts</span><span class="p">))</span>


<div class="viewcode-block" id="doctest"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.doctest">[docs]</a><span class="k">def</span> <span class="nf">doctest</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs doctests in all \*.py files in the sympy directory which match</span>
<span class="sd">    any of the given strings in ``paths`` or all tests if paths=[].</span>

<span class="sd">    Notes:</span>

<span class="sd">    - Paths can be entered in native system format or in unix,</span>
<span class="sd">      forward-slash format.</span>
<span class="sd">    - Files that are on the blacklist can be tested by providing</span>
<span class="sd">      their path; they are only excluded if no paths are given.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; import sympy</span>

<span class="sd">    Run all tests:</span>

<span class="sd">    &gt;&gt;&gt; sympy.doctest() # doctest: +SKIP</span>

<span class="sd">    Run one file:</span>

<span class="sd">    &gt;&gt;&gt; sympy.doctest(&quot;sympy/core/basic.py&quot;) # doctest: +SKIP</span>
<span class="sd">    &gt;&gt;&gt; sympy.doctest(&quot;polynomial.rst&quot;) # doctest: +SKIP</span>

<span class="sd">    Run all tests in sympy/functions/ and some particular file:</span>

<span class="sd">    &gt;&gt;&gt; sympy.doctest(&quot;/functions&quot;, &quot;basic.py&quot;) # doctest: +SKIP</span>

<span class="sd">    Run any file having polynomial in its name, doc/src/modules/polynomial.rst,</span>
<span class="sd">    sympy/functions/special/polynomials.py, and sympy/polys/polynomial.py:</span>

<span class="sd">    &gt;&gt;&gt; sympy.doctest(&quot;polynomial&quot;) # doctest: +SKIP</span>

<span class="sd">    The ``subprocess`` and ``verbose`` options are the same as with the function</span>
<span class="sd">    ``test()``.  See the docstring of that function for more information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">subprocess</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;subprocess&quot;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">subprocess</span><span class="p">:</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">run_in_subprocess_with_hash_randomization</span><span class="p">(</span><span class="s">&quot;_doctest&quot;</span><span class="p">,</span>
            <span class="n">function_args</span><span class="o">=</span><span class="n">paths</span><span class="p">,</span> <span class="n">function_kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_doctest</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

</div>
<span class="k">def</span> <span class="nf">_doctest</span><span class="p">(</span><span class="o">*</span><span class="n">paths</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal function that actually runs the doctests.</span>

<span class="sd">    All keyword arguments from ``doctest()`` are passed to this function</span>
<span class="sd">    except for ``subprocess``.</span>

<span class="sd">    Returns 0 if tests passed and 1 if they failed.  See the docstrings of</span>
<span class="sd">    ``doctest()`` and ``test()`` for more information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">normal</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;normal&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;verbose&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
    <span class="n">blacklist</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;blacklist&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">blacklist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="s">&quot;doc/src/modules/mpmath&quot;</span><span class="p">,</span>  <span class="c"># needs to be fixed upstream</span>
        <span class="s">&quot;sympy/mpmath&quot;</span><span class="p">,</span>  <span class="c"># needs to be fixed upstream</span>
        <span class="s">&quot;doc/src/modules/plotting.rst&quot;</span><span class="p">,</span>  <span class="c"># generates live plots</span>
        <span class="s">&quot;sympy/statistics&quot;</span><span class="p">,</span>                <span class="c"># prints a deprecation</span>
        <span class="s">&quot;doc/src/modules/statistics.rst&quot;</span><span class="p">,</span>  <span class="c"># warning (the module is deprecated)</span>
        <span class="s">&quot;sympy/utilities/compilef.py&quot;</span>  <span class="c"># needs tcc</span>
    <span class="p">])</span>

    <span class="k">if</span> <span class="n">import_module</span><span class="p">(</span><span class="s">&#39;numpy&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">blacklist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="s">&quot;sympy/plotting/experimental_lambdify.py&quot;</span><span class="p">,</span>
            <span class="s">&quot;sympy/plotting/plot_implicit.py&quot;</span><span class="p">,</span>
            <span class="s">&quot;examples/advanced/autowrap_integrators.py&quot;</span><span class="p">,</span>
            <span class="s">&quot;examples/advanced/autowrap_ufuncify.py&quot;</span><span class="p">,</span>
            <span class="s">&quot;examples/intermediate/sample.py&quot;</span><span class="p">,</span>
            <span class="s">&quot;examples/intermediate/mplot2d.py&quot;</span><span class="p">,</span>
            <span class="s">&quot;examples/intermediate/mplot3d.py&quot;</span>
        <span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">import_module</span><span class="p">(</span><span class="s">&#39;matplotlib&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">blacklist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="s">&quot;examples/intermediate/mplot2d.py&quot;</span><span class="p">,</span>
                <span class="s">&quot;examples/intermediate/mplot3d.py&quot;</span>
            <span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># don&#39;t display matplotlib windows</span>
            <span class="kn">from</span> <span class="nn">sympy.plotting.plot</span> <span class="kn">import</span> <span class="n">unset_show</span>
            <span class="n">unset_show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">import_module</span><span class="p">(</span><span class="s">&#39;pyglet&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">blacklist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s">&quot;sympy/plotting/pygletplot&quot;</span><span class="p">])</span>

    <span class="c"># disabled because of doctest failures in asmeurer&#39;s bot</span>
    <span class="n">blacklist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="s">&quot;sympy/utilities/autowrap.py&quot;</span><span class="p">,</span>
        <span class="s">&quot;examples/advanced/autowrap_integrators.py&quot;</span><span class="p">,</span>
        <span class="s">&quot;examples/advanced/autowrap_ufuncify.py&quot;</span>
        <span class="p">])</span>

    <span class="c"># pytest = import_module(&#39;pytest&#39;)</span>
    <span class="c"># py = import_module(&#39;py&#39;)</span>
    <span class="c"># if py is None or pytest is None:</span>
    <span class="c">#     blacklist.extend([</span>
    <span class="c">#         &quot;sympy/conftest.py&quot;,</span>
    <span class="c">#         &quot;sympy/utilities/benchmarking.py&quot;</span>
    <span class="c">#     ])</span>

    <span class="c"># blacklist these modules until issue 1741 is resolved</span>
    <span class="n">blacklist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
        <span class="s">&quot;sympy/conftest.py&quot;</span><span class="p">,</span>
        <span class="s">&quot;sympy/utilities/benchmarking.py&quot;</span>
    <span class="p">])</span>

    <span class="n">blacklist</span> <span class="o">=</span> <span class="n">convert_to_native_paths</span><span class="p">(</span><span class="n">blacklist</span><span class="p">)</span>

    <span class="c"># Disable warnings for external modules</span>
    <span class="kn">import</span> <span class="nn">sympy.external</span>
    <span class="n">sympy</span><span class="o">.</span><span class="n">external</span><span class="o">.</span><span class="n">importtools</span><span class="o">.</span><span class="n">WARN_OLD_VERSION</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">sympy</span><span class="o">.</span><span class="n">external</span><span class="o">.</span><span class="n">importtools</span><span class="o">.</span><span class="n">WARN_NOT_INSTALLED</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># Show deprecation warnings</span>
    <span class="kn">import</span> <span class="nn">warnings</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s">&quot;error&quot;</span><span class="p">,</span> <span class="n">SymPyDeprecationWarning</span><span class="p">)</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">PyTestReporter</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">SymPyDocTests</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>

    <span class="n">test_files</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_test_files</span><span class="p">(</span><span class="s">&#39;sympy&#39;</span><span class="p">)</span>
    <span class="n">test_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">get_test_files</span><span class="p">(</span><span class="s">&#39;examples&#39;</span><span class="p">,</span> <span class="n">init_only</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

    <span class="n">not_blacklisted</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">test_files</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">_testfiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">not_blacklisted</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># take only what was requested...but not blacklisted items</span>
        <span class="c"># and allow for partial match anywhere or fnmatch of name</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">convert_to_native_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">not_blacklisted</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
                    <span class="n">matched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">break</span>
        <span class="n">t</span><span class="o">.</span><span class="n">_testfiles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">matched</span><span class="p">)</span>

    <span class="c"># run the tests and record the result for this *py portion of the tests</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">_testfiles</span><span class="p">:</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">failed</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># N.B.</span>
    <span class="c"># --------------------------------------------------------------------</span>
    <span class="c"># Here we test *.rst files at or below doc/src. Code from these must</span>
    <span class="c"># be self supporting in terms of imports since there is no importing</span>
    <span class="c"># of necessary modules by doctest.testfile. If you try to pass *.py</span>
    <span class="c"># files through this they might fail because they will lack the needed</span>
    <span class="c"># imports and smarter parsing that can be done with source code.</span>
    <span class="c">#</span>
    <span class="n">test_files</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">get_test_files</span><span class="p">(</span><span class="s">&#39;doc/src&#39;</span><span class="p">,</span> <span class="s">&#39;*.rst&#39;</span><span class="p">,</span> <span class="n">init_only</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">test_files</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

    <span class="n">not_blacklisted</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">test_files</span>
                       <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">b</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">)]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="n">not_blacklisted</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># Take only what was requested as long as it&#39;s not on the blacklist.</span>
        <span class="c"># Paths were already made native in *py tests so don&#39;t repeat here.</span>
        <span class="c"># There&#39;s no chance of having a *py file slip through since we</span>
        <span class="c"># only have *rst files in test_files.</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">not_blacklisted</span><span class="p">:</span>
            <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">f</span> <span class="ow">or</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">basename</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
                    <span class="n">matched</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">break</span>

    <span class="n">setup_pprint</span><span class="p">()</span>
    <span class="n">first_report</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">for</span> <span class="n">rst_file</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rst_file</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">old_displayhook</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">displayhook</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># out = pdoctest.testfile(</span>
            <span class="c">#    rst_file, module_relative=False, encoding=&#39;utf-8&#39;,</span>
            <span class="c">#    optionflags=pdoctest.ELLIPSIS | pdoctest.NORMALIZE_WHITESPACE)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">sympytestfile</span><span class="p">(</span>
                <span class="n">rst_file</span><span class="p">,</span> <span class="n">module_relative</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span>
                <span class="n">optionflags</span><span class="o">=</span><span class="n">pdoctest</span><span class="o">.</span><span class="n">ELLIPSIS</span> <span class="o">|</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">NORMALIZE_WHITESPACE</span> <span class="o">|</span>
                <span class="n">pdoctest</span><span class="o">.</span><span class="n">IGNORE_EXCEPTION_DETAIL</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c"># make sure we return to the original displayhook in case some</span>
            <span class="c"># doctest has changed that</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">displayhook</span> <span class="o">=</span> <span class="n">old_displayhook</span>

        <span class="n">rstfailed</span><span class="p">,</span> <span class="n">tested</span> <span class="o">=</span> <span class="n">out</span>
        <span class="k">if</span> <span class="n">tested</span><span class="p">:</span>
            <span class="n">failed</span> <span class="o">=</span> <span class="n">rstfailed</span> <span class="ow">or</span> <span class="n">failed</span>
            <span class="k">if</span> <span class="n">first_report</span><span class="p">:</span>
                <span class="n">first_report</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;rst doctests start&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">t</span><span class="o">.</span><span class="n">_testfiles</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">()</span>
            <span class="c"># use as the id, everything past the first &#39;sympy&#39;</span>
            <span class="n">file_id</span> <span class="o">=</span> <span class="n">rst_file</span><span class="p">[</span><span class="n">rst_file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;sympy&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="s">&#39;sympy&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
            <span class="k">print</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s">&quot; &quot;</span><span class="p">)</span>
                <span class="c"># get at least the name out so it is know who is being tested</span>
            <span class="n">wid</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">terminal_width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_id</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c"># update width</span>
            <span class="n">test_file</span> <span class="o">=</span> <span class="s">&#39;[</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tested</span><span class="p">)</span>
            <span class="n">report</span> <span class="o">=</span> <span class="s">&#39;[</span><span class="si">%s</span><span class="s">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rstfailed</span> <span class="ow">or</span> <span class="s">&#39;OK&#39;</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="p">[</span><span class="n">test_file</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="o">*</span><span class="p">(</span><span class="n">wid</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_file</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">report</span><span class="p">)),</span> <span class="n">report</span><span class="p">])</span>
            <span class="p">)</span>

    <span class="c"># the doctests for *py will have printed this message already if there was</span>
    <span class="c"># a failure, so now only print it if there was intervening reporting by</span>
    <span class="c"># testing the *rst as evidenced by first_report no longer being True.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">first_report</span> <span class="ow">and</span> <span class="n">failed</span><span class="p">:</span>
        <span class="k">print</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;DO *NOT* COMMIT!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">failed</span><span class="p">)</span>


<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="n">SymPyTestResults</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s">&#39;TestResults&#39;</span><span class="p">,</span> <span class="s">&#39;failed attempted&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="sympytestfile"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.sympytestfile">[docs]</a><span class="k">def</span> <span class="nf">sympytestfile</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">module_relative</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">package</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
             <span class="n">globs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">report</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
             <span class="n">extraglobs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">raise_on_error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
             <span class="n">parser</span><span class="o">=</span><span class="n">pdoctest</span><span class="o">.</span><span class="n">DocTestParser</span><span class="p">(),</span> <span class="n">encoding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test examples in the given file.  Return (#failures, #tests).</span>

<span class="sd">    Optional keyword arg ``module_relative`` specifies how filenames</span>
<span class="sd">    should be interpreted:</span>

<span class="sd">    - If ``module_relative`` is True (the default), then ``filename``</span>
<span class="sd">      specifies a module-relative path.  By default, this path is</span>
<span class="sd">      relative to the calling module&#39;s directory; but if the</span>
<span class="sd">      ``package`` argument is specified, then it is relative to that</span>
<span class="sd">      package.  To ensure os-independence, ``filename`` should use</span>
<span class="sd">      &quot;/&quot; characters to separate path segments, and should not</span>
<span class="sd">      be an absolute path (i.e., it may not begin with &quot;/&quot;).</span>

<span class="sd">    - If ``module_relative`` is False, then ``filename`` specifies an</span>
<span class="sd">      os-specific path.  The path may be absolute or relative (to</span>
<span class="sd">      the current working directory).</span>

<span class="sd">    Optional keyword arg ``name`` gives the name of the test; by default</span>
<span class="sd">    use the file&#39;s basename.</span>

<span class="sd">    Optional keyword argument ``package`` is a Python package or the</span>
<span class="sd">    name of a Python package whose directory should be used as the</span>
<span class="sd">    base directory for a module relative filename.  If no package is</span>
<span class="sd">    specified, then the calling module&#39;s directory is used as the base</span>
<span class="sd">    directory for module relative filenames.  It is an error to</span>
<span class="sd">    specify ``package`` if ``module_relative`` is False.</span>

<span class="sd">    Optional keyword arg ``globs`` gives a dict to be used as the globals</span>
<span class="sd">    when executing examples; by default, use {}.  A copy of this dict</span>
<span class="sd">    is actually used for each docstring, so that each docstring&#39;s</span>
<span class="sd">    examples start with a clean slate.</span>

<span class="sd">    Optional keyword arg ``extraglobs`` gives a dictionary that should be</span>
<span class="sd">    merged into the globals that are used to execute examples.  By</span>
<span class="sd">    default, no extra globals are used.</span>

<span class="sd">    Optional keyword arg ``verbose`` prints lots of stuff if true, prints</span>
<span class="sd">    only failures if false; by default, it&#39;s true iff &quot;-v&quot; is in sys.argv.</span>

<span class="sd">    Optional keyword arg ``report`` prints a summary at the end when true,</span>
<span class="sd">    else prints nothing at the end.  In verbose mode, the summary is</span>
<span class="sd">    detailed, else very brief (in fact, empty if all tests passed).</span>

<span class="sd">    Optional keyword arg ``optionflags`` or&#39;s together module constants,</span>
<span class="sd">    and defaults to 0.  Possible values (see the docs for details):</span>

<span class="sd">    - DONT_ACCEPT_TRUE_FOR_1</span>
<span class="sd">    - DONT_ACCEPT_BLANKLINE</span>
<span class="sd">    - NORMALIZE_WHITESPACE</span>
<span class="sd">    - ELLIPSIS</span>
<span class="sd">    - SKIP</span>
<span class="sd">    - IGNORE_EXCEPTION_DETAIL</span>
<span class="sd">    - REPORT_UDIFF</span>
<span class="sd">    - REPORT_CDIFF</span>
<span class="sd">    - REPORT_NDIFF</span>
<span class="sd">    - REPORT_ONLY_FIRST_FAILURE</span>

<span class="sd">    Optional keyword arg ``raise_on_error`` raises an exception on the</span>
<span class="sd">    first unexpected exception or failure. This allows failures to be</span>
<span class="sd">    post-mortem debugged.</span>

<span class="sd">    Optional keyword arg ``parser`` specifies a DocTestParser (or</span>
<span class="sd">    subclass) that should be used to extract tests from the files.</span>

<span class="sd">    Optional keyword arg ``encoding`` specifies an encoding that should</span>
<span class="sd">    be used to convert the file to unicode.</span>

<span class="sd">    Advanced tomfoolery:  testmod runs methods of a local instance of</span>
<span class="sd">    class doctest.Tester, then merges the results into (or creates)</span>
<span class="sd">    global Tester instance doctest.master.  Methods of doctest.master</span>
<span class="sd">    can be called directly too, if you want to do something unusual.</span>
<span class="sd">    Passing report=0 to testmod is especially useful then, to delay</span>
<span class="sd">    displaying a summary.  Invoke doctest.master.summarize(verbose)</span>
<span class="sd">    when you&#39;re done fiddling.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">package</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">module_relative</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;Package may only be specified for module-&quot;</span>
                         <span class="s">&quot;relative paths.&quot;</span><span class="p">)</span>

    <span class="c"># Relativize the path</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">IS_PYTHON_3</span><span class="p">:</span>
        <span class="n">text</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">_load_testfile</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">module_relative</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">text</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">_load_testfile</span><span class="p">(</span>
            <span class="n">filename</span><span class="p">,</span> <span class="n">package</span><span class="p">,</span> <span class="n">module_relative</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>

    <span class="c"># If no name was given, then use the file&#39;s name.</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="c"># Assemble the globals.</span>
    <span class="k">if</span> <span class="n">globs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">globs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">globs</span> <span class="o">=</span> <span class="n">globs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">extraglobs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">globs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">extraglobs</span><span class="p">)</span>
    <span class="k">if</span> <span class="s">&#39;__name__&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">globs</span><span class="p">:</span>
        <span class="n">globs</span><span class="p">[</span><span class="s">&#39;__name__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;__main__&#39;</span>

    <span class="k">if</span> <span class="n">raise_on_error</span><span class="p">:</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">DebugRunner</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="n">optionflags</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">runner</span> <span class="o">=</span> <span class="n">SymPyDocTestRunner</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">optionflags</span><span class="o">=</span><span class="n">optionflags</span><span class="p">)</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">_checker</span> <span class="o">=</span> <span class="n">SymPyOutputChecker</span><span class="p">()</span>

    <span class="c"># Read the file, convert it to a test, and run it.</span>
    <span class="n">test</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_doctest</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">compileflags</span><span class="o">=</span><span class="n">future_flags</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">report</span><span class="p">:</span>
        <span class="n">runner</span><span class="o">.</span><span class="n">summarize</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">master</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">pdoctest</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="n">runner</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pdoctest</span><span class="o">.</span><span class="n">master</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">runner</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">SymPyTestResults</span><span class="p">(</span><span class="n">runner</span><span class="o">.</span><span class="n">failures</span><span class="p">,</span> <span class="n">runner</span><span class="o">.</span><span class="n">tries</span><span class="p">)</span>

</div>
<span class="k">class</span> <span class="nc">SymPyTests</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reporter</span><span class="p">,</span> <span class="n">kw</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">post_mortem</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_post_mortem</span> <span class="o">=</span> <span class="n">post_mortem</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_kw</span> <span class="o">=</span> <span class="n">kw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span> <span class="o">=</span> <span class="n">sympy_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span> <span class="o">=</span> <span class="n">reporter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">root_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_testfiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seed</span> <span class="o">=</span> <span class="n">seed</span> <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">slow</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">enhance_asserts</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the tests returning True if all tests pass, otherwise False.</span>

<span class="sd">        If sort=False run tests in random order.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_testfiles</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">shuffle</span>
            <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seed</span><span class="p">)</span>
            <span class="n">shuffle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_testfiles</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seed</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testfiles</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_file</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sort</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">slow</span><span class="p">,</span> <span class="n">enhance_asserts</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot; interrupted by user&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_enhance_asserts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="p">(</span><span class="n">NodeTransformer</span><span class="p">,</span> <span class="n">Compare</span><span class="p">,</span> <span class="n">Name</span><span class="p">,</span> <span class="n">Store</span><span class="p">,</span> <span class="n">Load</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span>
            <span class="n">Assign</span><span class="p">,</span> <span class="n">BinOp</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> <span class="n">Mod</span><span class="p">,</span> <span class="n">Assert</span><span class="p">,</span> <span class="n">parse</span><span class="p">,</span> <span class="n">fix_missing_locations</span><span class="p">)</span>

        <span class="n">ops</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Eq&quot;</span><span class="p">:</span> <span class="s">&#39;==&#39;</span><span class="p">,</span> <span class="s">&quot;NotEq&quot;</span><span class="p">:</span> <span class="s">&#39;!=&#39;</span><span class="p">,</span> <span class="s">&quot;Lt&quot;</span><span class="p">:</span> <span class="s">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s">&quot;LtE&quot;</span><span class="p">:</span> <span class="s">&#39;&lt;=&#39;</span><span class="p">,</span>
                <span class="s">&quot;Gt&quot;</span><span class="p">:</span> <span class="s">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s">&quot;GtE&quot;</span><span class="p">:</span> <span class="s">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="s">&quot;Is&quot;</span><span class="p">:</span> <span class="s">&#39;is&#39;</span><span class="p">,</span> <span class="s">&quot;IsNot&quot;</span><span class="p">:</span> <span class="s">&#39;is not&#39;</span><span class="p">,</span>
                <span class="s">&quot;In&quot;</span><span class="p">:</span> <span class="s">&#39;in&#39;</span><span class="p">,</span> <span class="s">&quot;NotIn&quot;</span><span class="p">:</span> <span class="s">&#39;not in&#39;</span><span class="p">}</span>

        <span class="k">class</span> <span class="nc">Transform</span><span class="p">(</span><span class="n">NodeTransformer</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">visit_Assert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stmt</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stmt</span><span class="o">.</span><span class="n">test</span><span class="p">,</span> <span class="n">Compare</span><span class="p">):</span>
                    <span class="n">compare</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">test</span>
                    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">compare</span><span class="o">.</span><span class="n">left</span><span class="p">]</span> <span class="o">+</span> <span class="n">compare</span><span class="o">.</span><span class="n">comparators</span>
                    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span> <span class="s">&quot;_</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="p">]</span>
                    <span class="n">names_store</span> <span class="o">=</span> <span class="p">[</span> <span class="n">Name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Store</span><span class="p">())</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="p">]</span>
                    <span class="n">names_load</span> <span class="o">=</span> <span class="p">[</span> <span class="n">Name</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">Load</span><span class="p">())</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">names</span> <span class="p">]</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="n">names_store</span><span class="p">,</span> <span class="n">Store</span><span class="p">())</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">Load</span><span class="p">())</span>
                    <span class="n">assign</span> <span class="o">=</span> <span class="n">Assign</span><span class="p">([</span><span class="n">target</span><span class="p">],</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">new_compare</span> <span class="o">=</span> <span class="n">Compare</span><span class="p">(</span><span class="n">names_load</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">compare</span><span class="o">.</span><span class="n">ops</span><span class="p">,</span> <span class="n">names_load</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                    <span class="n">msg_format</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">+</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s"> &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="n">ops</span><span class="p">[</span><span class="n">op</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">compare</span><span class="o">.</span><span class="n">ops</span> <span class="p">])</span> <span class="o">+</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s">&quot;</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">BinOp</span><span class="p">(</span><span class="n">Str</span><span class="p">(</span><span class="n">msg_format</span><span class="p">),</span> <span class="n">Mod</span><span class="p">(),</span> <span class="n">Tuple</span><span class="p">(</span><span class="n">names_load</span><span class="p">,</span> <span class="n">Load</span><span class="p">()))</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="n">Assert</span><span class="p">(</span><span class="n">new_compare</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="n">stmt</span><span class="o">.</span><span class="n">lineno</span><span class="p">,</span> <span class="n">col_offset</span><span class="o">=</span><span class="n">stmt</span><span class="o">.</span><span class="n">col_offset</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">assign</span><span class="p">,</span> <span class="n">test</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">stmt</span>

        <span class="n">tree</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">new_tree</span> <span class="o">=</span> <span class="n">Transform</span><span class="p">()</span><span class="o">.</span><span class="n">visit</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fix_missing_locations</span><span class="p">(</span><span class="n">new_tree</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">slow</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">enhance_asserts</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">clear_cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">gl</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;__file__&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">}</span>
        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seed</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">IS_PYTHON_3</span><span class="p">:</span>
                <span class="n">open_file</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">open_file</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

            <span class="k">with</span> <span class="n">open_file</span><span class="p">()</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">source</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">enhance_asserts</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_enhance_asserts</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&quot;exec&quot;</span><span class="p">)</span>
            <span class="n">exec_</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">gl</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">import_error</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">return</span>
        <span class="n">pytestfile</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&quot;XFAIL&quot;</span> <span class="ow">in</span> <span class="n">gl</span><span class="p">:</span>
            <span class="n">pytestfile</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="n">gl</span><span class="p">[</span><span class="s">&quot;XFAIL&quot;</span><span class="p">])</span>
        <span class="n">pytestfile2</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="s">&quot;slow&quot;</span> <span class="ow">in</span> <span class="n">gl</span><span class="p">:</span>
            <span class="n">pytestfile2</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="n">gl</span><span class="p">[</span><span class="s">&quot;slow&quot;</span><span class="p">])</span>
        <span class="n">disabled</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;disabled&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">disabled</span><span class="p">:</span>
            <span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># we need to filter only those functions that begin with &#39;test_&#39;</span>
            <span class="c"># that are defined in the testing file or in the file where</span>
            <span class="c"># is defined the XFAIL decorator</span>
            <span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">gl</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">gl</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;test_&quot;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">gl</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">gl</span><span class="p">[</span><span class="n">f</span><span class="p">]))</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="n">gl</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="o">==</span> <span class="n">filename</span> <span class="ow">or</span>
                 <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="n">gl</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="o">==</span> <span class="n">pytestfile</span> <span class="ow">or</span>
                 <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcefile</span><span class="p">(</span><span class="n">gl</span><span class="p">[</span><span class="n">f</span><span class="p">])</span> <span class="o">==</span> <span class="n">pytestfile2</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">slow</span><span class="p">:</span>
                <span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">funcs</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;_slow&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)]</span>
            <span class="c"># Sorting of XFAILed functions isn&#39;t fixed yet :-(</span>
            <span class="n">funcs</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getsourcelines</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">funcs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">funcs</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
                <span class="c"># some tests can be generators, that return the actual</span>
                <span class="c"># test functions. We unpack it below:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="n">funcs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">fg</span> <span class="ow">in</span> <span class="n">f</span><span class="p">():</span>
                        <span class="n">func</span> <span class="o">=</span> <span class="n">fg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">fg</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                        <span class="n">fgw</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">funcs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fgw</span><span class="p">)</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="c"># drop functions that are not selected with the keyword expression:</span>
            <span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">funcs</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">entering_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">funcs</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">entering_test</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;_slow&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">slow</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">Skipped</span><span class="p">(</span><span class="s">&quot;Slow&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_seed</span><span class="p">)</span>
                    <span class="n">f</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;_slow&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">test_skip</span><span class="p">(</span><span class="s">&quot;KeyboardInterrupt&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># Disable the alarm. It could not be handled before.</span>
                <span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ne">AssertionError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">test_fail</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tr</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_mortem</span><span class="p">:</span>
                        <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;Skipped&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">test_skip</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;XFail&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">test_xfail</span><span class="p">()</span>
                <span class="k">elif</span> <span class="n">t</span><span class="o">.</span><span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;XPass&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">test_xpass</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">test_exception</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">tr</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_mortem</span><span class="p">:</span>
                        <span class="n">pdb</span><span class="o">.</span><span class="n">post_mortem</span><span class="p">(</span><span class="n">tr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">test_pass</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">leaving_filename</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">Skipped</span><span class="p">(</span><span class="s">&quot;Timeout&quot;</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">callback</span><span class="p">)</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>  <span class="c"># Set an alarm with a given timeout</span>
        <span class="n">function</span><span class="p">()</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">alarm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c"># Disable the alarm</span>

    <span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Does the keyword expression self._kw match &quot;x&quot;? Returns True/False.</span>

<span class="sd">        Always returns True if self._kw is &quot;&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kw</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">__name__</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_kw</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">def</span> <span class="nf">get_test_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s">&#39;test_*.py&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of test_*.py (default) files at or below directory</span>
<span class="sd">        ``dir`` relative to the sympy home directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">,</span> <span class="n">convert_to_native_paths</span><span class="p">([</span><span class="nb">dir</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">g</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">pat</span><span class="p">)])</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">sys_normcase</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span> <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">g</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">SymPyDocTests</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reporter</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span> <span class="o">=</span> <span class="n">sympy_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span> <span class="o">=</span> <span class="n">reporter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">root_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_normal</span> <span class="o">=</span> <span class="n">normal</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_testfiles</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the tests and returns True if all tests pass, otherwise False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_testfiles</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">test_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot; interrupted by user&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>
                <span class="k">raise</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">finish</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">test_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">clear_cache</span><span class="p">()</span>

        <span class="kn">from</span> <span class="nn">sympy.core.compatibility</span> <span class="kn">import</span> <span class="n">StringIO</span>

        <span class="n">rel_name</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">dirname</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">rel_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">,</span> <span class="s">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">rel_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;examples&quot;</span><span class="p">):</span>
            <span class="c"># Examples files do not have __init__.py files,</span>
            <span class="c"># So we have to temporarily extend sys.path to import them</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dirname</span><span class="p">)</span>
            <span class="n">module</span> <span class="o">=</span> <span class="nb">file</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>  <span class="c"># remove &quot;.py&quot;</span>
        <span class="n">setup_pprint</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">_normalize_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="n">tests</span> <span class="o">=</span> <span class="n">SymPyDocTestFinder</span><span class="p">()</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">SystemExit</span><span class="p">,</span> <span class="ne">KeyboardInterrupt</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">import_error</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
            <span class="k">return</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rel_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;examples&quot;</span><span class="p">):</span>
                <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">tests</span> <span class="o">=</span> <span class="p">[</span><span class="n">test</span> <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tests</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">examples</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="c"># By default tests are sorted by alphabetical order by function name.</span>
        <span class="c"># We sort by line number so one can edit the file sequentially from</span>
        <span class="c"># bottom to top. However, if there are decorated functions, their line</span>
        <span class="c"># numbers will be too large and for now one must just search for these</span>
        <span class="c"># by text and function name.</span>
        <span class="n">tests</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="o">.</span><span class="n">lineno</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">tests</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">entering_filename</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tests</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">test</span> <span class="ow">in</span> <span class="n">tests</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">examples</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>

            <span class="c"># check if there are external dependencies which need to be met</span>
            <span class="k">if</span> <span class="s">&#39;_doctest_depends_on&#39;</span> <span class="ow">in</span> <span class="n">test</span><span class="o">.</span><span class="n">globs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_dependencies</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">globs</span><span class="p">[</span><span class="s">&#39;_doctest_depends_on&#39;</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">test_skip</span><span class="p">()</span>
                    <span class="k">continue</span>

            <span class="n">runner</span> <span class="o">=</span> <span class="n">SymPyDocTestRunner</span><span class="p">(</span><span class="n">optionflags</span><span class="o">=</span><span class="n">pdoctest</span><span class="o">.</span><span class="n">ELLIPSIS</span> <span class="o">|</span>
                    <span class="n">pdoctest</span><span class="o">.</span><span class="n">NORMALIZE_WHITESPACE</span> <span class="o">|</span>
                    <span class="n">pdoctest</span><span class="o">.</span><span class="n">IGNORE_EXCEPTION_DETAIL</span><span class="p">)</span>
            <span class="n">runner</span><span class="o">.</span><span class="n">_checker</span> <span class="o">=</span> <span class="n">SymPyOutputChecker</span><span class="p">()</span>
            <span class="n">old</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">new</span>
            <span class="c"># If the testing is normal, the doctests get importing magic to</span>
            <span class="c"># provide the global namespace. If not normal (the default) then</span>
            <span class="c"># then must run on their own; all imports must be explicit within</span>
            <span class="c"># a function&#39;s docstring. Once imported that import will be</span>
            <span class="c"># available to the rest of the tests in a given function&#39;s</span>
            <span class="c"># docstring (unless clear_globs=True below).</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normal</span><span class="p">:</span>
                <span class="n">test</span><span class="o">.</span><span class="n">globs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="c"># if this is uncommented then all the test would get is what</span>
                <span class="c"># comes by default with a &quot;from sympy import *&quot;</span>
                <span class="c">#exec(&#39;from sympy import *&#39;) in test.globs</span>
            <span class="n">test</span><span class="o">.</span><span class="n">globs</span><span class="p">[</span><span class="s">&#39;print_function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">print_function</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">compileflags</span><span class="o">=</span><span class="n">future_flags</span><span class="p">,</span>
                                  <span class="n">out</span><span class="o">=</span><span class="n">new</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">clear_globs</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">old</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">doctest_fail</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">new</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">test_pass</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reporter</span><span class="o">.</span><span class="n">leaving_filename</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_test_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">,</span> <span class="n">pat</span><span class="o">=</span><span class="s">&#39;*.py&#39;</span><span class="p">,</span> <span class="n">init_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the list of \*.py files (default) from which docstrings</span>
<span class="sd">        will be tested which are at or below directory ``dir``. By default,</span>
<span class="sd">        only those that have an __init__.py in their parent directory</span>
<span class="sd">        and do not start with ``test_`` will be included.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">importable</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Checks if given pathname x is an importable module by checking for</span>
<span class="sd">            __init__.py file.</span>

<span class="sd">            Returns True/False.</span>

<span class="sd">            Currently we only test if the __init__.py file exists in the</span>
<span class="sd">            directory with the file &quot;x&quot; (in theory we should also test all the</span>
<span class="sd">            parent dirs).</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">init_py</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s">&quot;__init__.py&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">init_py</span><span class="p">)</span>

        <span class="nb">dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">,</span> <span class="n">convert_to_native_paths</span><span class="p">([</span><span class="nb">dir</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">g</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span><span class="p">,</span> <span class="n">folders</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
            <span class="n">g</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span>
                      <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;test_&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fnmatch</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">pat</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">init_only</span><span class="p">:</span>
            <span class="c"># skip files that are not importable (i.e. missing __init__.py)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">g</span> <span class="k">if</span> <span class="n">importable</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">sys_normcase</span><span class="p">(</span><span class="n">gi</span><span class="p">)</span> <span class="k">for</span> <span class="n">gi</span> <span class="ow">in</span> <span class="n">g</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_process_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">deps</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``False`` if some dependencies are not met and the test should be</span>
<span class="sd">        skipped otherwise returns ``True``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">executables</span> <span class="o">=</span> <span class="n">deps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;exe&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">moduledeps</span> <span class="o">=</span> <span class="n">deps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;modules&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">viewers</span> <span class="o">=</span> <span class="n">deps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;disable_viewers&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">pyglet</span> <span class="o">=</span> <span class="n">deps</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;pyglet&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c"># print deps</span>

        <span class="k">if</span> <span class="n">executables</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">executables</span><span class="p">:</span>
                <span class="n">found</span> <span class="o">=</span> <span class="n">find_executable</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="c"># print &quot;EXE %s found %s&quot; %(ex, found)</span>
                <span class="k">if</span> <span class="n">found</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">moduledeps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">extmod</span> <span class="ow">in</span> <span class="n">moduledeps</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">extmod</span> <span class="o">==</span> <span class="s">&#39;matplotlib&#39;</span><span class="p">:</span>
                    <span class="n">matplotlib</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span>
                        <span class="s">&#39;matplotlib&#39;</span><span class="p">,</span>
                        <span class="n">__import__kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;fromlist&#39;</span><span class="p">:</span>
                                          <span class="p">[</span><span class="s">&#39;pyplot&#39;</span><span class="p">,</span> <span class="s">&#39;cm&#39;</span><span class="p">,</span> <span class="s">&#39;collections&#39;</span><span class="p">]},</span>
                        <span class="n">min_module_version</span><span class="o">=</span><span class="s">&#39;1.0.0&#39;</span><span class="p">,</span> <span class="n">catch</span><span class="o">=</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">,))</span>
                    <span class="k">if</span> <span class="n">matplotlib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">pass</span>
                        <span class="c"># print &quot;EXTMODULE matplotlib version %s found&quot; % \</span>
                        <span class="c">#     matplotlib.__version__</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># print &quot;EXTMODULE matplotlib &gt; 1.0.0 not found&quot;</span>
                        <span class="k">return</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># TODO min version support</span>
                    <span class="n">mod</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">extmod</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mod</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span>
                        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="s">&#39;__version__&#39;</span><span class="p">):</span>
                            <span class="n">version</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">__version__</span>
                        <span class="c"># print &quot;EXTMODULE %s version %s found&quot; %(extmod, version)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># print &quot;EXTMODULE %s not found&quot; %(extmod)</span>
                        <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">viewers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">tempfile</span>
            <span class="n">tempdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH&#39;</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="s">&#39;#!/usr/bin/env python3</span><span class="se">\n</span><span class="s">&#39;</span> \
                     <span class="s">&#39;import sys</span><span class="se">\n</span><span class="s">&#39;</span> \
                     <span class="s">&#39;if len(sys.argv) &lt;= 1:</span><span class="se">\n</span><span class="s">&#39;</span> \
                     <span class="s">&#39;    exit(&quot;wrong number of args&quot;)</span><span class="se">\n</span><span class="s">&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vw</span> <span class="o">=</span> <span class="s">&#39;#!/usr/bin/env python</span><span class="se">\n</span><span class="s">&#39;</span> \
                     <span class="s">&#39;import sys</span><span class="se">\n</span><span class="s">&#39;</span> \
                     <span class="s">&#39;if len(sys.argv) &lt;= 1:</span><span class="se">\n</span><span class="s">&#39;</span> \
                     <span class="s">&#39;    exit(&quot;wrong number of args&quot;)</span><span class="se">\n</span><span class="s">&#39;</span>

            <span class="k">for</span> <span class="n">viewer</span> <span class="ow">in</span> <span class="n">viewers</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">viewer</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
                    <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">vw</span><span class="p">)</span>

                <span class="c"># make the file executable</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tempdir</span><span class="p">,</span> <span class="n">viewer</span><span class="p">),</span>
                         <span class="n">stat</span><span class="o">.</span><span class="n">S_IREAD</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWRITE</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pyglet</span><span class="p">:</span>
            <span class="c"># monkey-patch pyglet s.t. it does not open a window during</span>
            <span class="c"># doctesting</span>
            <span class="kn">import</span> <span class="nn">pyglet</span>
            <span class="k">class</span> <span class="nc">DummyWindow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
                <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">has_exit</span><span class="o">=</span><span class="bp">True</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">600</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">400</span>

                <span class="k">def</span> <span class="nf">set_vsync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                    <span class="k">pass</span>

                <span class="k">def</span> <span class="nf">switch_to</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">pass</span>

                <span class="k">def</span> <span class="nf">push_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
                    <span class="k">pass</span>

                <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                    <span class="k">pass</span>

            <span class="n">pyglet</span><span class="o">.</span><span class="n">window</span><span class="o">.</span><span class="n">Window</span> <span class="o">=</span> <span class="n">DummyWindow</span>

        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="SymPyDocTestFinder"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.SymPyDocTestFinder">[docs]</a><span class="k">class</span> <span class="nc">SymPyDocTestFinder</span><span class="p">(</span><span class="n">DocTestFinder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class used to extract the DocTests that are relevant to a given</span>
<span class="sd">    object, from its docstring and the docstrings of its contained</span>
<span class="sd">    objects.  Doctests can currently be extracted from the following</span>
<span class="sd">    object types: modules, functions, classes, methods, staticmethods,</span>
<span class="sd">    classmethods, and properties.</span>

<span class="sd">    Modified from doctest&#39;s version by looking harder for code in the</span>
<span class="sd">    case that it looks like the the code comes from a different module.</span>
<span class="sd">    In the case of decorated functions (e.g. @vectorize) they appear</span>
<span class="sd">    to come from a different module (e.g. multidemensional) even though</span>
<span class="sd">    their code is not there.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tests</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">source_lines</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find tests for the given object and any contained objects, and</span>
<span class="sd">        add them to ``tests``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;Finding tests in </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

        <span class="c"># If we&#39;ve already processed this object, then ignore it.</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">seen</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c"># Make sure we don&#39;t run doctests for classes outside of sympy, such</span>
        <span class="c"># as in numpy or scipy.</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;sympy&#39;</span><span class="p">:</span>
                <span class="k">return</span>

        <span class="c"># Find a test for this object, and add it to the list of tests.</span>
        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_test</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">source_lines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">test</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurse</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c"># Look for tests in a module&#39;s contained objects.</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">rawname</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c"># Recurse to functions &amp; classes.</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
                    <span class="c"># Make sure we don&#39;t run doctests functions or classes</span>
                    <span class="c"># from different modules</span>
                    <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">__module__</span> <span class="o">!=</span> <span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_module</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span> \
                        <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not in module </span><span class="si">%s</span><span class="s"> (rawname </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">rawname</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">valname</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">rawname</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valname</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span>
                                   <span class="n">source_lines</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="k">pass</span>

            <span class="c"># Look for tests in a module&#39;s __test__ dictionary.</span>
            <span class="k">for</span> <span class="n">valname</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;__test__&#39;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">valname</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;SymPyDocTestFinder.find: __test__ keys &quot;</span>
                                     <span class="s">&quot;must be strings: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">valname</span><span class="p">),))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismodule</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span>
                        <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">string_types</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;SymPyDocTestFinder.find: __test__ values &quot;</span>
                                     <span class="s">&quot;must be strings, functions, methods, &quot;</span>
                                     <span class="s">&quot;classes, or modules: </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span>
                                     <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">),))</span>
                <span class="n">valname</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.__test__.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">valname</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valname</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">source_lines</span><span class="p">,</span>
                           <span class="n">globs</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span>

        <span class="c"># Look for tests in a class&#39;s contained objects.</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">valname</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c"># Special handling for staticmethod/classmethod.</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">valname</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">valname</span><span class="p">)</span><span class="o">.</span><span class="n">__func__</span>

                <span class="c"># Recurse to methods, properties, and nested classes.</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">property</span><span class="p">)):</span>
                    <span class="c"># Make sure we don&#39;t run doctests functions or classes</span>
                    <span class="c"># from different modules</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">fget</span><span class="o">.</span><span class="n">__module__</span> <span class="o">!=</span> <span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span>
                            <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">__module__</span> <span class="o">!=</span> <span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">:</span>
                            <span class="k">continue</span>

                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_module</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">val</span><span class="p">),</span> \
                        <span class="s">&quot;</span><span class="si">%s</span><span class="s"> is not in module </span><span class="si">%s</span><span class="s"> (valname </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">valname</span><span class="p">)</span>

                    <span class="n">valname</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">valname</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_find</span><span class="p">(</span><span class="n">tests</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">valname</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">source_lines</span><span class="p">,</span>
                               <span class="n">globs</span><span class="p">,</span> <span class="n">seen</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">source_lines</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a DocTest for the given object, if it defines a docstring;</span>
<span class="sd">        otherwise, return None.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">lineno</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Extract the object&#39;s docstring.  If it doesn&#39;t have one,</span>
        <span class="c"># then return None (no test for this object).</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="c"># obj is a string in the case for objects in the polys package.</span>
            <span class="c"># Note that source_lines is a binary string (compiled polys</span>
            <span class="c"># modules), which can&#39;t be handled by _find_lineno so determine</span>
            <span class="c"># the line number here.</span>

            <span class="n">docstring</span> <span class="o">=</span> <span class="n">obj</span>

            <span class="n">matches</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s">&quot;line \d+&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> \
                <span class="s">&quot;string &#39;</span><span class="si">%s</span><span class="s">&#39; does not contain lineno &quot;</span> <span class="o">%</span> <span class="n">name</span>

            <span class="c"># NOTE: this is not the exact linenumber but its better than no</span>
            <span class="c"># lineno ;)</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">5</span><span class="p">:])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__doc__</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">docstring</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">docstring</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__doc__</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">docstring</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                        <span class="n">docstring</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
                <span class="n">docstring</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

        <span class="c"># Don&#39;t bother if the docstring is empty.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exclude_empty</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">docstring</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># check that properties have a docstring because _find_lineno</span>
        <span class="c"># assumes it</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="o">.</span><span class="n">__doc__</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>

        <span class="c"># Find the docstring&#39;s location in the file.</span>
        <span class="k">if</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># handling of properties is not implemented in _find_lineno so do</span>
            <span class="c"># it here</span>
            <span class="n">tobj</span> <span class="o">=</span> <span class="n">obj</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">property</span><span class="p">)</span> <span class="k">else</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span>
            <span class="n">lineno</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_lineno</span><span class="p">(</span><span class="n">tobj</span><span class="p">,</span> <span class="n">source_lines</span><span class="p">)</span>

        <span class="k">assert</span> <span class="n">lineno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

        <span class="c"># Return a DocTest for this object.</span>
        <span class="k">if</span> <span class="n">module</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="s">&#39;__file__&#39;</span><span class="p">,</span> <span class="n">module</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;.pyc&quot;</span><span class="p">,</span> <span class="s">&quot;.pyo&quot;</span><span class="p">):</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s">&#39;_doctest_depends_on&#39;</span><span class="p">):</span>
            <span class="n">globs</span><span class="p">[</span><span class="s">&#39;_doctest_depends_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_doctest_depends_on</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">globs</span><span class="p">[</span><span class="s">&#39;_doctest_depends_on&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parser</span><span class="o">.</span><span class="n">get_doctest</span><span class="p">(</span><span class="n">docstring</span><span class="p">,</span> <span class="n">globs</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
                                        <span class="n">filename</span><span class="p">,</span> <span class="n">lineno</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="SymPyDocTestRunner"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.SymPyDocTestRunner">[docs]</a><span class="k">class</span> <span class="nc">SymPyDocTestRunner</span><span class="p">(</span><span class="n">DocTestRunner</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class used to run DocTest test cases, and accumulate statistics.</span>
<span class="sd">    The ``run`` method is used to process a single DocTest case.  It</span>
<span class="sd">    returns a tuple ``(f, t)``, where ``t`` is the number of test cases</span>
<span class="sd">    tried, and ``f`` is the number of test cases that failed.</span>

<span class="sd">    Modified from the doctest version to not reset the sys.displayhook (see</span>
<span class="sd">    issue 2041).</span>

<span class="sd">    See the docstring of the original DocTestRunner for more information.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SymPyDocTestRunner.run"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.SymPyDocTestRunner.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test</span><span class="p">,</span> <span class="n">compileflags</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">clear_globs</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the examples in ``test``, and display the results using the</span>
<span class="sd">        writer function ``out``.</span>

<span class="sd">        The examples are run in the namespace ``test.globs``.  If</span>
<span class="sd">        ``clear_globs`` is true (the default), then this namespace will</span>
<span class="sd">        be cleared after the test runs, to help with garbage</span>
<span class="sd">        collection.  If you would like to examine the namespace after</span>
<span class="sd">        the test completes, then use ``clear_globs=False``.</span>

<span class="sd">        ``compileflags`` gives the set of flags that should be used by</span>
<span class="sd">        the Python compiler when running the examples.  If not</span>
<span class="sd">        specified, then it will default to the set of future-import</span>
<span class="sd">        flags that apply to ``globs``.</span>

<span class="sd">        The output of each example is checked using</span>
<span class="sd">        ``SymPyDocTestRunner.check_output``, and the results are</span>
<span class="sd">        formatted by the ``SymPyDocTestRunner.report_*`` methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test</span> <span class="o">=</span> <span class="n">test</span>

        <span class="k">if</span> <span class="n">compileflags</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">compileflags</span> <span class="o">=</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">_extract_future_flags</span><span class="p">(</span><span class="n">test</span><span class="o">.</span><span class="n">globs</span><span class="p">)</span>

        <span class="n">save_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">save_stdout</span><span class="o">.</span><span class="n">write</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fakeout</span>

        <span class="c"># Patch pdb.set_trace to restore sys.stdout during interactive</span>
        <span class="c"># debugging (so it&#39;s not still redirected to self._fakeout).</span>
        <span class="c"># Note that the interactive output will go to *our*</span>
        <span class="c"># save_stdout, even if that&#39;s not the real sys.stdout; this</span>
        <span class="c"># allows us to write test cases for the set_trace behavior.</span>
        <span class="n">save_set_trace</span> <span class="o">=</span> <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span> <span class="o">=</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">_OutputRedirectingPdb</span><span class="p">(</span><span class="n">save_stdout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">debugger</span><span class="o">.</span><span class="n">set_trace</span>

        <span class="c"># Patch linecache.getlines, so we can see the example&#39;s source</span>
        <span class="c"># when we&#39;re inside the debugger.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_linecache_getlines</span> <span class="o">=</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">linecache</span><span class="o">.</span><span class="n">getlines</span>
        <span class="n">linecache</span><span class="o">.</span><span class="n">getlines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__patched_linecache_getlines</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">test</span><span class="o">.</span><span class="n">globs</span><span class="p">[</span><span class="s">&#39;print_function&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">print_function</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">compileflags</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">save_stdout</span>
            <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span> <span class="o">=</span> <span class="n">save_set_trace</span>
            <span class="n">linecache</span><span class="o">.</span><span class="n">getlines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_linecache_getlines</span>
            <span class="k">if</span> <span class="n">clear_globs</span><span class="p">:</span>
                <span class="n">test</span><span class="o">.</span><span class="n">globs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<span class="c"># We have to override the name mangled methods.</span></div></div>
<span class="n">SymPyDocTestRunner</span><span class="o">.</span><span class="n">_SymPyDocTestRunner__patched_linecache_getlines</span> <span class="o">=</span> \
    <span class="n">DocTestRunner</span><span class="o">.</span><span class="n">_DocTestRunner__patched_linecache_getlines</span>
<span class="n">SymPyDocTestRunner</span><span class="o">.</span><span class="n">_SymPyDocTestRunner__run</span> <span class="o">=</span> <span class="n">DocTestRunner</span><span class="o">.</span><span class="n">_DocTestRunner__run</span>
<span class="n">SymPyDocTestRunner</span><span class="o">.</span><span class="n">_SymPyDocTestRunner__record_outcome</span> <span class="o">=</span> \
    <span class="n">DocTestRunner</span><span class="o">.</span><span class="n">_DocTestRunner__record_outcome</span>


<div class="viewcode-block" id="SymPyOutputChecker"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.SymPyOutputChecker">[docs]</a><span class="k">class</span> <span class="nc">SymPyOutputChecker</span><span class="p">(</span><span class="n">pdoctest</span><span class="o">.</span><span class="n">OutputChecker</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compared to the OutputChecker from the stdlib our OutputChecker class</span>
<span class="sd">    supports numerical comparison of floats occuring in the output of the</span>
<span class="sd">    doctest examples</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># NOTE OutputChecker is an old-style class with no __init__ method,</span>
        <span class="c"># so we can&#39;t call the base class version of __init__ here</span>

        <span class="n">got_floats</span> <span class="o">=</span> <span class="s">r&#39;(\d+\.\d*|\.\d+)&#39;</span>

        <span class="c"># floats in the &#39;want&#39; string may contain ellipses</span>
        <span class="n">want_floats</span> <span class="o">=</span> <span class="n">got_floats</span> <span class="o">+</span> <span class="s">r&#39;(\.{3})?&#39;</span>

        <span class="n">front_sep</span> <span class="o">=</span> <span class="s">r&#39;\s|\+|\-|\*|,&#39;</span>
        <span class="n">back_sep</span> <span class="o">=</span> <span class="n">front_sep</span> <span class="o">+</span> <span class="s">r&#39;|j|e&#39;</span>

        <span class="n">fbeg</span> <span class="o">=</span> <span class="s">r&#39;^</span><span class="si">%s</span><span class="s">(?=</span><span class="si">%s</span><span class="s">|$)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">got_floats</span><span class="p">,</span> <span class="n">back_sep</span><span class="p">)</span>
        <span class="n">fmidend</span> <span class="o">=</span> <span class="s">r&#39;(?&lt;=</span><span class="si">%s</span><span class="s">)</span><span class="si">%s</span><span class="s">(?=</span><span class="si">%s</span><span class="s">|$)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">front_sep</span><span class="p">,</span> <span class="n">got_floats</span><span class="p">,</span> <span class="n">back_sep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_got_rgx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">fbeg</span><span class="p">,</span> <span class="n">fmidend</span><span class="p">))</span>

        <span class="n">fbeg</span> <span class="o">=</span> <span class="s">r&#39;^</span><span class="si">%s</span><span class="s">(?=</span><span class="si">%s</span><span class="s">|$)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">want_floats</span><span class="p">,</span> <span class="n">back_sep</span><span class="p">)</span>
        <span class="n">fmidend</span> <span class="o">=</span> <span class="s">r&#39;(?&lt;=</span><span class="si">%s</span><span class="s">)</span><span class="si">%s</span><span class="s">(?=</span><span class="si">%s</span><span class="s">|$)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">front_sep</span><span class="p">,</span> <span class="n">want_floats</span><span class="p">,</span> <span class="n">back_sep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_want_rgx</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;(</span><span class="si">%s</span><span class="s">|</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">fbeg</span><span class="p">,</span> <span class="n">fmidend</span><span class="p">))</span>

<div class="viewcode-block" id="SymPyOutputChecker.check_output"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.SymPyOutputChecker.check_output">[docs]</a>    <span class="k">def</span> <span class="nf">check_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">,</span> <span class="n">optionflags</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True iff the actual output from an example (`got`)</span>
<span class="sd">        matches the expected output (`want`).  These strings are</span>
<span class="sd">        always considered to match if they are identical; but</span>
<span class="sd">        depending on what option flags the test runner is using,</span>
<span class="sd">        several non-exact match types are also possible.  See the</span>
<span class="sd">        documentation for `TestRunner` for more information about</span>
<span class="sd">        option flags.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Handle the common case first, for efficiency:</span>
        <span class="c"># if they&#39;re string-identical, always return true.</span>
        <span class="k">if</span> <span class="n">got</span> <span class="o">==</span> <span class="n">want</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="c"># TODO parse integers as well ?</span>
        <span class="c"># Parse floats and compare them. If some of the parsed floats contain</span>
        <span class="c"># ellipses, skip the comparison.</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_got_rgx</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">got</span><span class="p">)</span>
        <span class="n">numbers_got</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span> <span class="c"># list of strs</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_want_rgx</span><span class="o">.</span><span class="n">finditer</span><span class="p">(</span><span class="n">want</span><span class="p">)</span>
        <span class="n">numbers_want</span> <span class="o">=</span> <span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">match</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">]</span> <span class="c"># list of strs</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers_got</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers_want</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">numbers_got</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">nw_</span>  <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ng</span><span class="p">,</span> <span class="n">nw</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">numbers_got</span><span class="p">,</span> <span class="n">numbers_want</span><span class="p">):</span>
                <span class="k">if</span> <span class="s">&#39;...&#39;</span> <span class="ow">in</span> <span class="n">nw</span><span class="p">:</span>
                    <span class="n">nw_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ng</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nw_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nw</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">ng</span><span class="p">)</span><span class="o">-</span><span class="nb">float</span><span class="p">(</span><span class="n">nw</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">1e-5</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">False</span>

            <span class="n">got</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_got_rgx</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
            <span class="n">got</span> <span class="o">=</span> <span class="n">got</span> <span class="o">%</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">nw_</span><span class="p">)</span>

        <span class="c"># &lt;BLANKLINE&gt; can be used as a special sequence to signify a</span>
        <span class="c"># blank line, unless the DONT_ACCEPT_BLANKLINE flag is used.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">optionflags</span> <span class="o">&amp;</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">DONT_ACCEPT_BLANKLINE</span><span class="p">):</span>
            <span class="c"># Replace &lt;BLANKLINE&gt; in want with a blank line.</span>
            <span class="n">want</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;(?m)^</span><span class="si">%s</span><span class="s">\s*?$&#39;</span> <span class="o">%</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">pdoctest</span><span class="o">.</span><span class="n">BLANKLINE_MARKER</span><span class="p">),</span>
                          <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">want</span><span class="p">)</span>
            <span class="c"># If a line in got contains only spaces, then remove the</span>
            <span class="c"># spaces.</span>
            <span class="n">got</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&#39;(?m)^\s*?$&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">got</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">got</span> <span class="o">==</span> <span class="n">want</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="c"># This flag causes doctest to ignore any differences in the</span>
        <span class="c"># contents of whitespace strings.  Note that this can be used</span>
        <span class="c"># in conjunction with the ELLIPSIS flag.</span>
        <span class="k">if</span> <span class="n">optionflags</span> <span class="o">&amp;</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">NORMALIZE_WHITESPACE</span><span class="p">:</span>
            <span class="n">got</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">got</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="n">want</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">want</span><span class="o">.</span><span class="n">split</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">got</span> <span class="o">==</span> <span class="n">want</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="c"># The ELLIPSIS flag says to let the sequence &quot;...&quot; in `want`</span>
        <span class="c"># match any substring in `got`.</span>
        <span class="k">if</span> <span class="n">optionflags</span> <span class="o">&amp;</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">ELLIPSIS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pdoctest</span><span class="o">.</span><span class="n">_ellipsis_match</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="n">got</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>

        <span class="c"># We didn&#39;t find any match; return false.</span>
        <span class="k">return</span> <span class="bp">False</span>

</div></div>
<div class="viewcode-block" id="Reporter"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.Reporter">[docs]</a><span class="k">class</span> <span class="nc">Reporter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parent class for all reporters.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">pass</span>

</div>
<div class="viewcode-block" id="PyTestReporter"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.PyTestReporter">[docs]</a><span class="k">class</span> <span class="nc">PyTestReporter</span><span class="p">(</span><span class="n">Reporter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Py.test like reporter. Should produce output identical to py.test.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="s">&quot;short&quot;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                 <span class="n">force_colors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tb_style</span> <span class="o">=</span> <span class="n">tb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_colors</span> <span class="o">=</span> <span class="n">colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_force_colors</span> <span class="o">=</span> <span class="n">force_colors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfailed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xpassed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed_doctest</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_passed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skipped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminal_width</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_width</span> <span class="o">=</span> <span class="mi">80</span>

        <span class="c"># this tracks the x-position of the cursor (useful for positioning</span>
        <span class="c"># things on the screen), without the need for any readline library:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_pos</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line_wrap</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">root_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">dir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span> <span class="o">=</span> <span class="nb">dir</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">terminal_width</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminal_width</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_terminal_width</span>

        <span class="k">def</span> <span class="nf">findout_terminal_width</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>
                <span class="c"># Windows support is based on:</span>
                <span class="c">#</span>
                <span class="c">#  http://code.activestate.com/recipes/</span>
                <span class="c">#  440694-determine-size-of-console-window-on-windows/</span>

                <span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">windll</span><span class="p">,</span> <span class="n">create_string_buffer</span>

                <span class="n">h</span> <span class="o">=</span> <span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetStdHandle</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>
                <span class="n">csbi</span> <span class="o">=</span> <span class="n">create_string_buffer</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">windll</span><span class="o">.</span><span class="n">kernel32</span><span class="o">.</span><span class="n">GetConsoleScreenBufferInfo</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">csbi</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">res</span><span class="p">:</span>
                    <span class="kn">import</span> <span class="nn">struct</span>
                    <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> \
                        <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&quot;hhhhHhhhhhh&quot;</span><span class="p">,</span> <span class="n">csbi</span><span class="o">.</span><span class="n">raw</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_width</span>

            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#39;isatty&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_width</span>  <span class="c"># leave PIPEs alone</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&#39;stty&#39;</span><span class="p">,</span> <span class="s">&#39;-a&#39;</span><span class="p">],</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="n">stdout</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># We support the following output formats from stty:</span>
                <span class="c">#</span>
                <span class="c"># 1) Linux   -&gt; columns 80</span>
                <span class="c"># 2) OS X    -&gt; 80 columns</span>
                <span class="c"># 3) Solaris -&gt; columns = 80</span>

                <span class="n">re_linux</span> <span class="o">=</span> <span class="s">r&quot;columns\s+(?P&lt;columns&gt;\d+);&quot;</span>
                <span class="n">re_osx</span> <span class="o">=</span> <span class="s">r&quot;(?P&lt;columns&gt;\d+)\s*columns;&quot;</span>
                <span class="n">re_solaris</span> <span class="o">=</span> <span class="s">r&quot;columns\s+=\s+(?P&lt;columns&gt;\d+);&quot;</span>

                <span class="k">for</span> <span class="n">regex</span> <span class="ow">in</span> <span class="p">(</span><span class="n">re_linux</span><span class="p">,</span> <span class="n">re_osx</span><span class="p">,</span> <span class="n">re_solaris</span><span class="p">):</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">stdout</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">columns</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;columns&#39;</span><span class="p">)</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>

            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_width</span>

        <span class="n">width</span> <span class="o">=</span> <span class="n">findout_terminal_width</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminal_width</span> <span class="o">=</span> <span class="n">width</span>

        <span class="k">return</span> <span class="n">width</span>

<div class="viewcode-block" id="PyTestReporter.write"><a class="viewcode-back" href="../../../modules/utilities/runtests.html#sympy.utilities.runtests.PyTestReporter.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&quot;left&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
              <span class="n">force_colors</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints a text on the screen.</span>

<span class="sd">        It uses sys.stdout.write(), so no readline library is necessary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ==========</span>

<span class="sd">        color : choose from the colors below, &quot;&quot; means default color</span>
<span class="sd">        align : &quot;left&quot;/&quot;right&quot;, &quot;left&quot; is a normal print, &quot;right&quot; is aligned on</span>
<span class="sd">                the right-hand side of the screen, filled with spaces if</span>
<span class="sd">                necessary</span>
<span class="sd">        width : the screen width</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">color_templates</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s">&quot;Black&quot;</span><span class="p">,</span> <span class="s">&quot;0;30&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Red&quot;</span><span class="p">,</span> <span class="s">&quot;0;31&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Green&quot;</span><span class="p">,</span> <span class="s">&quot;0;32&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Brown&quot;</span><span class="p">,</span> <span class="s">&quot;0;33&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Blue&quot;</span><span class="p">,</span> <span class="s">&quot;0;34&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Purple&quot;</span><span class="p">,</span> <span class="s">&quot;0;35&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Cyan&quot;</span><span class="p">,</span> <span class="s">&quot;0;36&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;LightGray&quot;</span><span class="p">,</span> <span class="s">&quot;0;37&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;DarkGray&quot;</span><span class="p">,</span> <span class="s">&quot;1;30&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;LightRed&quot;</span><span class="p">,</span> <span class="s">&quot;1;31&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;LightGreen&quot;</span><span class="p">,</span> <span class="s">&quot;1;32&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;Yellow&quot;</span><span class="p">,</span> <span class="s">&quot;1;33&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;LightBlue&quot;</span><span class="p">,</span> <span class="s">&quot;1;34&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;LightPurple&quot;</span><span class="p">,</span> <span class="s">&quot;1;35&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;LightCyan&quot;</span><span class="p">,</span> <span class="s">&quot;1;36&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s">&quot;White&quot;</span><span class="p">,</span> <span class="s">&quot;1;37&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">colors</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">color_templates</span><span class="p">:</span>
            <span class="n">colors</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">c_normal</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[0m&#39;</span>
        <span class="n">c_color</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\033</span><span class="s">[</span><span class="si">%s</span><span class="s">m&#39;</span>

        <span class="k">if</span> <span class="n">width</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span>

        <span class="k">if</span> <span class="n">align</span> <span class="o">==</span> <span class="s">&quot;right&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_pos</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">width</span><span class="p">:</span>
                <span class="c"># we don&#39;t fit on the current line, create a new line</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="o">*</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_pos</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_force_colors</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="s">&#39;isatty&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> \
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
            <span class="c"># the stdout is not a terminal, this for example happens if the</span>
            <span class="c"># output is piped to less, e.g. &quot;bin/test | less&quot;. In this case,</span>
            <span class="c"># the terminal control sequences would be printed verbatim, so</span>
            <span class="c"># don&#39;t use any colors.</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s">&quot;win32&quot;</span><span class="p">:</span>
            <span class="c"># Windows consoles don&#39;t support ANSI escape sequences</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colors</span><span class="p">:</span>
            <span class="n">color</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_line_wrap</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">text</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="c"># Avoid UnicodeEncodeError when printing out test failures</span>
        <span class="k">if</span> <span class="n">IS_PYTHON_3</span> <span class="ow">and</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;raw_unicode_escape&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf8&#39;</span><span class="p">,</span> <span class="s">&#39;ignore&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">IS_PYTHON_3</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;utf&#39;</span><span class="p">):</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">,</span> <span class="s">&#39;backslashreplace&#39;</span>
                              <span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">encoding</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s%s%s</span><span class="s">&quot;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">c_color</span> <span class="o">%</span> <span class="n">colors</span><span class="p">[</span><span class="n">color</span><span class="p">],</span> <span class="n">text</span><span class="p">,</span> <span class="n">c_normal</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_pos</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write_pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_line_wrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_write_pos</span> <span class="o">&gt;=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_write_pos</span> <span class="o">%=</span> <span class="n">width</span>
</div>
    <span class="k">def</span> <span class="nf">write_center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">delim</span><span class="o">=</span><span class="s">&quot;=&quot;</span><span class="p">):</span>
        <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span>
        <span class="k">if</span> <span class="n">text</span> <span class="o">!=</span> <span class="s">&quot;&quot;</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">text</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">delim</span><span class="o">*</span><span class="n">idx</span> <span class="o">+</span> <span class="n">text</span> <span class="o">+</span> <span class="n">delim</span><span class="o">*</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">idx</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">write_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">extract_tb</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span>
        <span class="c"># remove the first item, as that is always runtests.py</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_list</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception_only</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&quot;test process starts&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">executable</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">)</span>
        <span class="n">python_version</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">v</span>
        <span class="n">implementation</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">python_implementation</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">implementation</span> <span class="o">==</span> <span class="s">&#39;PyPy&#39;</span><span class="p">:</span>
            <span class="n">implementation</span> <span class="o">+=</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">-</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">pypy_version_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;executable:         </span><span class="si">%s</span><span class="s">  (</span><span class="si">%s</span><span class="s">) [</span><span class="si">%s</span><span class="s">]</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">executable</span><span class="p">,</span> <span class="n">python_version</span><span class="p">,</span> <span class="n">implementation</span><span class="p">))</span>
        <span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">ARCH</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;architecture:       </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">ARCH</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">sympy.core.cache</span> <span class="kn">import</span> <span class="n">USE_CACHE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;cache:              </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">USE_CACHE</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">sympy.core.compatibility</span> <span class="kn">import</span> <span class="n">GROUND_TYPES</span><span class="p">,</span> <span class="n">HAS_GMPY</span>
        <span class="n">version</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">GROUND_TYPES</span> <span class="o">==</span><span class="s">&#39;gmpy&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">HAS_GMPY</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">gmpy</span>
            <span class="k">elif</span> <span class="n">HAS_GMPY</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">gmpy2</span> <span class="kn">as</span> <span class="nn">gmpy</span>
            <span class="n">version</span> <span class="o">=</span> <span class="n">gmpy</span><span class="o">.</span><span class="n">version</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;ground types:       </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GROUND_TYPES</span><span class="p">,</span> <span class="n">version</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;random seed:        </span><span class="si">%d</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">seed</span><span class="p">)</span>
        <span class="kn">from</span> <span class="nn">.misc</span> <span class="kn">import</span> <span class="n">HASH_RANDOMIZATION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;hash randomization: &quot;</span><span class="p">)</span>
        <span class="n">hash_seed</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;PYTHONHASHSEED&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;0&#39;</span>
        <span class="k">if</span> <span class="n">HASH_RANDOMIZATION</span> <span class="ow">and</span> <span class="p">(</span><span class="n">hash_seed</span> <span class="o">==</span> <span class="s">&quot;random&quot;</span> <span class="ow">or</span> <span class="nb">int</span><span class="p">(</span><span class="n">hash_seed</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;on (PYTHONHASHSEED=</span><span class="si">%s</span><span class="s">)</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">hash_seed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t_start</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">finish</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_t_end</span> <span class="o">=</span> <span class="n">clock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">global</span> <span class="n">text</span><span class="p">,</span> <span class="n">linelen</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;tests finished: </span><span class="si">%d</span><span class="s"> passed, &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_passed</span>
        <span class="n">linelen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">add_text</span><span class="p">(</span><span class="n">mytext</span><span class="p">):</span>
            <span class="k">global</span> <span class="n">text</span><span class="p">,</span> <span class="n">linelen</span>
            <span class="sd">&quot;&quot;&quot;Break new text if too long.&quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="n">linelen</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">mytext</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">terminal_width</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="n">linelen</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">text</span> <span class="o">+=</span> <span class="n">mytext</span>
            <span class="n">linelen</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mytext</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_text</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> failed, &quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_doctest</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_text</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> failed, &quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_doctest</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skipped</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_text</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> skipped, &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_skipped</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xfailed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_text</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> expected to fail, &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xfailed</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpassed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_text</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> expected to fail but passed, &quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpassed</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">add_text</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%d</span><span class="s"> exceptions, &quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span><span class="p">))</span>
        <span class="n">add_text</span><span class="p">(</span><span class="s">&quot;in </span><span class="si">%.2f</span><span class="s"> seconds&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_t_end</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_t_start</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_xpassed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="s">&quot;xpassed tests&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_xpassed</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tb_style</span> <span class="o">!=</span> <span class="s">&quot;no&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#self.write_center(&quot;These tests raised an exception&quot;, &quot;_&quot;)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span><span class="p">:</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span> <span class="o">=</span> <span class="n">e</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_exception</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tb_style</span> <span class="o">!=</span> <span class="s">&quot;no&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#self.write_center(&quot;Failed&quot;, &quot;_&quot;)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span><span class="p">:</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span> <span class="o">=</span> <span class="n">e</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span><span class="p">),</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_exception</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tb_style</span> <span class="o">!=</span> <span class="s">&quot;no&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_doctest</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c">#self.write_center(&quot;Failed&quot;, &quot;_&quot;)</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_failed_doctest</span><span class="p">:</span>
                <span class="n">filename</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">e</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">write_center</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> \
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_failed_doctest</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;DO *NOT* COMMIT!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ok</span>

    <span class="k">def</span> <span class="nf">entering_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="n">rel_name</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_file</span> <span class="o">=</span> <span class="n">rel_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_file_error</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rel_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;[</span><span class="si">%d</span><span class="s">] &quot;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">leaving_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_file_error</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;[FAIL]&quot;</span><span class="p">,</span> <span class="s">&quot;Red&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&quot;right&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;[OK]&quot;</span><span class="p">,</span> <span class="s">&quot;Green&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&quot;right&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">entering_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">f</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">&quot; &quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_xfail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xfailed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span> <span class="s">&quot;Green&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_xpass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_xpassed</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_file</span><span class="p">,</span> <span class="n">message</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;X&quot;</span><span class="p">,</span> <span class="s">&quot;Green&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_f</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;Red&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_file_error</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">doctest_fail</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">):</span>
        <span class="c"># the first line contains &quot;******&quot;, remove it:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">error_msg</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_failed_doctest</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;F&quot;</span><span class="p">,</span> <span class="s">&quot;Red&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_file_error</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">test_pass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">char</span><span class="o">=</span><span class="s">&quot;.&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_passed</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;ok&quot;</span><span class="p">,</span> <span class="s">&quot;Green&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">&quot;Green&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_skip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">char</span> <span class="o">=</span> <span class="s">&quot;s&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_skipped</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">message</span> <span class="o">==</span> <span class="s">&quot;KeyboardInterrupt&quot;</span><span class="p">:</span>
                <span class="n">char</span> <span class="o">=</span> <span class="s">&quot;K&quot;</span>
            <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="s">&quot;Timeout&quot;</span><span class="p">:</span>
                <span class="n">char</span> <span class="o">=</span> <span class="s">&quot;T&quot;</span>
            <span class="k">elif</span> <span class="n">message</span> <span class="o">==</span> <span class="s">&quot;Slow&quot;</span><span class="p">:</span>
                <span class="n">char</span> <span class="o">=</span> <span class="s">&quot;w&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">&quot;Blue&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbose</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; - &quot;</span><span class="p">,</span> <span class="s">&quot;Blue&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="s">&quot;Blue&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_exception</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_f</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;E&quot;</span><span class="p">,</span> <span class="s">&quot;Red&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_active_file_error</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">import_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filename</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">exc_info</span><span class="p">))</span>
        <span class="n">rel_name</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_root_dir</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">rel_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;[?]   Failed to import&quot;</span><span class="p">,</span> <span class="s">&quot;Red&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;[FAIL]&quot;</span><span class="p">,</span> <span class="s">&quot;Red&quot;</span><span class="p">,</span> <span class="n">align</span><span class="o">=</span><span class="s">&quot;right&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</div>
<span class="n">sympy_dir</span> <span class="o">=</span> <span class="n">get_sympy_dir</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../index.html">
              <img class="logo" src="../../../_static/sympylogo.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">SymPy 0.7.3 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li>
          <li><a href="../../sympy.html" >sympy</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013 SymPy Development Team.
      Last updated on Aug 04, 2013.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>