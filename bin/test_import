#!/usr/bin/env python

"""
Tests the speed of "import sympy" by measuring it many times in a row and
averaging the values.

Usage:

$ bin/test_import
"""

from __future__ import print_function

n_tests = 50

from pexpect import run
from numpy import mean, std
from get_sympy import path_hack

def test():
    t = run("python bin/test_import.py", cwd=path_hack())
    print(t)
    if not t or t.strip() == b'':
        print("Warning: Empty response from subprocess, skipping this run")
        return None
    try:
        t = float(t)
        return t
    except ValueError as e:
        print(f"Error converting '{t}' to float: {e}")
        return None

print("Start to Run Test:")
all_tests = [test() for x in range(n_tests + 1)]
# Filter out None values (failed runs)
tests = [t for t in all_tests if t is not None]
print("Note: the first run (warm up) was not included in the average + std dev")
print("All runs (including warm up):")
print(tests)
# skip the first run (warm up) if it exists:
if tests:
    tests = tests[1:]
    print("Number of successful tests: %d" % (len(tests)))
    if tests:
        print('The speed of "import sympy" is: %f +- %f' % (mean(tests), std(tests)))
    else:
        print("No successful tests after warm up")
else:
    print("No successful tests at all")
